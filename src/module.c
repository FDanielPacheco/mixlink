/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      module.c
 * 
 * @version   1.0
 *
 * @date      01-10-2025
 *
 * @brief     Opens modules for each section in the mixlink stack.
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <dlfcn.h>
#include <errno.h>
#include <stddef.h>

#include "mixlink.h"

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Data structures
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

// !< Struct used to identify the sections of the mixlink stack
struct lut_section{
  mixlink_stack_sections_t section;
  char interface[NAME_MAX];
}; 
 
/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Enumerations
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Lookup tables
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#define MIXLINK_N_STACK_SECTIONS 6
static const struct lut_section lut_sections[ MIXLINK_N_STACK_SECTIONS ] = {
  {MIXLINK_STACK_SECTION_TRANSLATOR_OPT   , "mixlink_translator_optimizer"},
  {MIXLINK_STACK_SECTION_TRANSLATOR_FRAMER, "mixlink_translator_framer"   },
  {MIXLINK_STACK_SECTION_CONTROLLER_SEGM  , "mixlink_controller_segmenter"},
  {MIXLINK_STACK_SECTION_CONTROLLER_QOS   , "mixlink_controller_qos"      },
  {MIXLINK_STACK_SECTION_CONTROLLER_FRAMER, "mixlink_controller_framer"   },
  {MIXLINK_STACK_SECTION_CONTROLLER_DRIVER, "mixlink_controller_driver"   },  
};

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Function protypes
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

const char * get_section_from_code( const mixlink_stack_sections_t code );

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Function Description
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
const char * 
get_section_from_code( 
  const mixlink_stack_sections_t code
){

  for( int i = 0 ; i < MIXLINK_N_STACK_SECTIONS ; ++i )
    if( lut_sections[i].section == code )
      return lut_sections[i].interface;

  return NULL;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_load( 
  const char * path,
  const mixlink_stack_sections_t section,
  mixlink_module_t * module
){

  if( !path || !module ){
    errno = EINVAL;
    return -1;
  }

  const char * iface_prefix = get_section_from_code( section );
  if( !iface_prefix ){
    errno = EINVAL;
    return -1;
  }  

  module->handle = dlopen( path, RTLD_NOW | RTLD_GLOBAL );
  if( !module->handle ){
    warning_print( "dlopen %s", dlerror( ) );
    return -1;
  }

  const int8_t n_options = 5;
  struct {
    const char * suffix;
    mixlink_callback_t * cb;
  } 
  callbacks[ ] = {
    {"setup", &module->setup},
    {"loop",  &module->loop },
    {"rx",    &module->rx   },
    {"tx",    &module->tx   },
    {"close", &module->close},
  };

  char symbol[NAME_MAX];
  for( int i = 0 ; i < n_options ; ++i ){
    snprintf( 
      symbol,
      sizeof(symbol),
      "%s_%s",
      get_section_from_code( section ),
      callbacks[i].suffix
    );

    dlerror( );
    callbacks[ i ].cb->fn = (int8_t (*)(void *)) dlsym( 
      module->handle, 
      symbol
    );

    const char * err = dlerror();
    callbacks[i].cb->enabled = (err == NULL); 
    
    if( err )
      warning_print( "symbol %s not found in %s", symbol, path );
  }
  return 0;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_exec(
  void * arg,
  mixlink_callback_t * cb
){
  
  if( !cb ){
    errno = EINVAL; 
    return -1;
  }

  if( cb->enabled )
    return cb->fn( arg );

  return -1;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_unload( 
  mixlink_module_t * module
){

  if( !module ){
    errno = EINVAL;
    return -1;
  }

  const int8_t n_options = 5;
  mixlink_callback_t * symbols[ ] = {
    &module->setup,
    &module->loop,
    &module->rx,   
    &module->tx,   
    &module->close
  };

  bool no_symbol_was_loaded = true;
  for( int8_t i = 0 ; i < n_options ; ++i )
    if( symbols[i]->enabled )
      no_symbol_was_loaded = false;

  if( no_symbol_was_loaded )
    return 0;

  return (int8_t) dlclose( module->handle );
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_io_cb(
  void * abi,
  const enum direction dir, 
  const mixlink_module_t * mod
){
  if( !mod || !abi ){
    errno = EINVAL;
    return 0;
  }      

  if( MIXLINK_DIRECTION_TO_NIC == dir )
    if( mod->rx.enabled )
      return mod->rx.fn( abi );
  
  if( MIXLINK_DIRECTION_FROM_NIC == dir )
    if( mod->tx.enabled )
      return mod->tx.fn( abi );

  return 0;  
}
