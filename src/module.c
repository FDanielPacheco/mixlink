/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      module.c
 * 
 * @version   1.0
 *
 * @date      01-10-2025
 *
 * @brief     Opens modules for each section in the mixlink stack.
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <dlfcn.h>
#include <errno.h>
#include <stddef.h>

#include "mixlink.h"

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Enumerations
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Function Description
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_load( 
  const char * path,
  const char * iface_prefix,
  mixlink_module_t * module
){

  if( !path || !iface_prefix || !module ){
    errno = EINVAL;
    return -1;
  }

  module->handle = dlopen( path, RTLD_NOW | RTLD_GLOBAL );
  if( !module->handle ){
    warning_print( "dlopen %s", dlerror( ) );
    return -1;
  }

  const int8_t n_options = 5;
  struct {
    const char * suffix;
    mixlink_callback_t * cb;
  } 
  callbacks[ ] = {
    {"init",   &module->init  },
    {"loop",   &module->loop  },
    {"rx",     &module->rx    },
    {"tx",     &module->tx    },
    {"deinit", &module->deinit},
  };

  char symbol[NAME_MAX];
  for( int i = 0 ; i < n_options ; ++i ){
    snprintf( 
      symbol,
      sizeof(symbol),
      "%s_%s",
      iface_prefix,
      callbacks[i].suffix
    );

    dlerror( );
    callbacks[ i ].cb->fn = (int8_t (*)(void *)) dlsym( 
      module->handle, 
      symbol
    );

    const char * err = dlerror();
    callbacks[i].cb->enabled = (err == NULL); 
    
    if( err )
      warning_print( "symbol %s not found in %s", symbol, path );
  }
  return 0;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_exec(
  void * arg,
  const mixlink_callback_t * cb
){
  
  if( !cb ){
    errno = EINVAL; 
    return -1;
  }

  if( cb->enabled )
    return cb->fn( arg );

  return 0;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_unload( 
  mixlink_module_t * module
){

  if( !module ){
    errno = EINVAL;
    return -1;
  }

  const int8_t n_options = 5;
  mixlink_callback_t * symbols[ ] = {
    &module->init,
    &module->loop,
    &module->rx,   
    &module->tx,   
    &module->deinit
  };

  bool no_symbol_was_loaded = true;
  for( int8_t i = 0 ; i < n_options ; ++i )
    if( symbols[i]->enabled )
      no_symbol_was_loaded = false;

  if( no_symbol_was_loaded )
    return 0;

  return (int8_t) dlclose( module->handle );
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/ 
int8_t 
mixlink_mod_exec_io(
  void * abi,
  const enum direction dir, 
  const mixlink_module_t * mod
){
  if( !mod || !abi ){
    errno = EINVAL;
    return -1;
  }      

  if( MIXLINK_DIRECTION_TO_NIC == dir )
    return mixlink_mod_exec( abi, &(mod->rx) );
  
  if( MIXLINK_DIRECTION_FROM_NIC == dir )
    return mixlink_mod_exec( abi, &(mod->tx) );

  return 0;  
}
